<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: "ca-pub-1919957041991194",
  enable_page_level_ads: true
});</script><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta content="author" name="ChanghuiN"><meta name="keywords" content="代码星冰乐,码小猪,I-team,FutureTask源码分析,FutureTask,Java源码分析"><meta name="description" content="&lt;p&gt;FutureTask：一个可取消的异步任务执行类，这个类提供了Future接口的基本实现，主要有以下功能：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;异步执行任务&lt;/li&gt;
&lt;li&gt;可以开始、取消以及查看任务是否完成&lt;/li&gt;
&lt;li&gt;如果任务没有执行完，get方法会导致线程阻塞&lt;/li&gt;
&lt;li&gt;一旦一个执行任务已经完成就不能再次开始和结束(除非执行时通过runAndReset()方法)&lt;/li&gt;
&lt;/ul&gt;"><title>FutureTask源码分析 - 代码星冰乐</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script type="text/javascript" src="https://dup.baidustatic.com/js/ds.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=UA-125332711-1" async></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-125332711-1');</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">FutureTask源码分析</h1><a id="logo" href="/.">代码星冰乐<img src="/favicon.ico" alt style="width: 34px; margin-left: 5px; vertical-align: bottom;"></a><p class="description">专注成就未来</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">FutureTask源码分析</h1><div class="post-meta">Apr 1, 2017<span> | </span><span class="author">ChanghuiN</span><span> | </span><span class="category"><a href="/categories/Java/">Java</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="blog_value_page_pv"></span><span> 阅读</span></span><script type="text/javascript">$(function() {
  var blog_url = window.location.href.split("?")[0];
  var fet_url = "/base-service/blog_read_count_incr?blogId=" + blog_url;
  fetch(fet_url).then(function(response){
    return response.json();
  }).then(function(data) {
    $("#blog_value_page_pv").text(data.data)
  }).catch(function (e) {
    console.log(e);
  })
});</script></div><div class="clear" style="margin-top: 12em;"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#类关系"><span class="toc-number">1.</span> <span class="toc-text">类关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#成员变量"><span class="toc-number">2.</span> <span class="toc-text">成员变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#构造函数及方法"><span class="toc-number">3.</span> <span class="toc-text">构造函数及方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#执行状态转换"><span class="toc-number">4.</span> <span class="toc-text">执行状态转换</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#主要方法"><span class="toc-number">5.</span> <span class="toc-text">主要方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#run"><span class="toc-number">5.1.</span> <span class="toc-text">run()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set"><span class="toc-number">5.2.</span> <span class="toc-text">set()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#finishCompletion"><span class="toc-number">5.3.</span> <span class="toc-text">finishCompletion()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cancel-boolean-mayInterruptIfRunning"><span class="toc-number">5.4.</span> <span class="toc-text">cancel(boolean mayInterruptIfRunning)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#get"><span class="toc-number">5.5.</span> <span class="toc-text">get()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#awaitDone-boolean-timed-long-nanos"><span class="toc-number">5.6.</span> <span class="toc-text">awaitDone(boolean timed, long nanos)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#用法示例"><span class="toc-number">6.</span> <span class="toc-text">用法示例</span></a></li></ol></div></div><div class="post-content" style="margin-top: -12em; display: none;"><blockquote style="margin: 10px 0;"><p style="margin: 1em 0"><span>作 者：</span><span class="author">ChanghuiN</span><br><span>原文链接：</span><a href="https://www.hchstudio.cn/article/2017/2b8f/">https://www.hchstudio.cn/article/2017/2b8f/</a><br><span>版权声明：非特殊声明均为本站原创作品，转载时请注明作者和原文链接。</span></p></blockquote><br><p><span> 由于版权原因，请阅读原文 --&gt; </span><a href="https://www.hchstudio.cn/article/2017/2b8f/">FutureTask源码分析</a></p><p> <img alt="关注我们" style="width: 66%" src="https://img.hchstudio.cn/dmxbl.jpg"></p><p style="margin-top: 40px; margin-bottom: 40px;"><span style="color: red;">作 者：</span><span class="author">ChanghuiN</span><br><span style="color: red;">原文链接：</span><a href="https://www.hchstudio.cn/article/2017/2b8f/">https://www.hchstudio.cn/article/2017/2b8f/</a><br><span style="color: red;">版权声明：非特殊声明均为本站原创作品，转载时请注明作者和原文链接。</span></p></div><div class="post-content_private" style="margin-top: -12em;"><blockquote style="margin: 10px 0;"><p style="margin: 1em 0"><span>作 者：</span><span class="author">ChanghuiN</span><br><span>原文链接：</span><a href="https://www.hchstudio.cn/article/2017/2b8f/">https://www.hchstudio.cn/article/2017/2b8f/</a><br><span>版权声明：非特殊声明均为本站原创作品，转载时请注明作者和原文链接。</span></p></blockquote><p>FutureTask：一个可取消的异步任务执行类，这个类提供了Future接口的基本实现，主要有以下功能：</p>
<ul>
<li>异步执行任务</li>
<li>可以开始、取消以及查看任务是否完成</li>
<li>如果任务没有执行完，get方法会导致线程阻塞</li>
<li>一旦一个执行任务已经完成就不能再次开始和结束(除非执行时通过runAndReset()方法)</li>
</ul>
<a id="more"></a>
<h2 id="类关系"><a href="#类关系" class="headerlink" title="类关系"></a>类关系</h2><p>先看一下类关系图：<br><img src="https://img.hchstudio.cn/20170403149119030734869.png" width="30%"><span class="caption">FutureTask类关系图.jpg</span></p>
<ul>
<li>Future为Java Tuture模式接口，Runable是实现异步操作的接口</li>
<li>RunnableFuture同时继承了以上两个接口，所以同时具有两种功能</li>
<li>而FutureTask为RunnableFuture的实现类</li>
</ul>
<h2 id="成员变量"><a href="#成员变量" class="headerlink" title="成员变量"></a>成员变量</h2><table>
<thead>
<tr>
<th>修饰符</th>
<th>变量名</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>private Callable<v></v></td>
<td>callable</td>
<td>任务的执行体</td>
</tr>
<tr>
<td>private Object</td>
<td>outcone</td>
<td>最终输出的结果</td>
</tr>
<tr>
<td>private volatile Thread</td>
<td>runner</td>
<td>异步执行任务的线程</td>
</tr>
<tr>
<td>private volatile WaitNode</td>
<td>waiters</td>
<td>获取任务结果的等待线程(是一个链式列表)</td>
</tr>
<tr>
<td>private volatile int</td>
<td>state</td>
<td>当前一步任务的状态</td>
</tr>
<tr>
<td>private static final int</td>
<td>NEW</td>
<td>任务初始化状态</td>
</tr>
<tr>
<td>private static final int</td>
<td>COMPLETING</td>
<td>任务已经完成，但结果还没有赋值给outcome</td>
</tr>
<tr>
<td>private static final int</td>
<td>NORMAL</td>
<td>任务执行完成</td>
</tr>
<tr>
<td>private static final int</td>
<td>EXCEPTIONAL</td>
<td>任务执行异常</td>
</tr>
<tr>
<td>private static final int</td>
<td>INTERRUPTING</td>
<td>任务被中断中</td>
</tr>
<tr>
<td>private static final int</td>
<td>INTERRUPTED</td>
<td>任务被中断</td>
</tr>
</tbody>
</table>
<h2 id="构造函数及方法"><a href="#构造函数及方法" class="headerlink" title="构造函数及方法"></a>构造函数及方法</h2><p>通过传入Callable来构造一个任务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public FutureTask(Callable&lt;V&gt; callable) &#123;</span><br><span class="line">    if (callable == null)</span><br><span class="line">        throw new NullPointerException();</span><br><span class="line">    this.callable = callable;</span><br><span class="line">    this.state = NEW;       // ensure visibility of callable</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过传人Runnable来构造一个任务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public FutureTask(Runnable runnable, V result) &#123;</span><br><span class="line">    this.callable = Executors.callable(runnable, result);</span><br><span class="line">    this.state = NEW;       // ensure visibility of callable</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上是两个构造函数，有构造函数可知，回家传入参数转换成Callable，然后放到callable变量里，将任务执行状态置为NEW。  </p>
<p>公共方法概要如下：  </p>
<table>
<thead>
<tr>
<th>修饰符</th>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>boolean</td>
<td>cancel(boolean mayInterruptIfRunning)</td>
<td>取消或者中断任务(true为中断，false为取消)</td>
</tr>
<tr>
<td>V</td>
<td>get()</td>
<td>返回执行结果，当为完成执行时，则阻塞线程</td>
</tr>
<tr>
<td>V</td>
<td>get(long timeout, TimeUnit unit)</td>
<td>获得执行结果，当时间超出设定时间时，则返回超时</td>
</tr>
<tr>
<td>boolean</td>
<td>isCancelled()</td>
<td>返回任务是否已经取消</td>
</tr>
<tr>
<td>boolean</td>
<td>isDone()</td>
<td>判断任务是否执行完毕</td>
</tr>
</tbody>
</table>
<h2 id="执行状态转换"><a href="#执行状态转换" class="headerlink" title="执行状态转换"></a>执行状态转换</h2><p>执行任务时可能有4种状态转换：</p>
<ol>
<li>任务顺利执行：NEW -&gt; COMPLETING -&gt; NORMAL</li>
<li>任务执行异常：NEW -&gt; COMPLETING -&gt; EXCEPTIONAL</li>
<li>任务取消：NEW -&gt; CANCELLED</li>
<li>任务中断：NEW -&gt; INTERRUPTING -&gt; INTERRUPTED</li>
</ol>
<h2 id="主要方法"><a href="#主要方法" class="headerlink" title="主要方法"></a>主要方法</h2><h3 id="run"><a href="#run" class="headerlink" title="run()"></a>run()</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">public void run() &#123;</span><br><span class="line">	//如果状态不是初始化后，则返回（避免重复执行）</span><br><span class="line">    if (state != NEW ||</span><br><span class="line">        !U.compareAndSwapObject(this, RUNNER, null, Thread.currentThread()))</span><br><span class="line">        return;</span><br><span class="line">    try &#123;</span><br><span class="line">        Callable&lt;V&gt; c = callable;</span><br><span class="line">        if (c != null &amp;&amp; state == NEW) &#123;</span><br><span class="line">            V result;</span><br><span class="line">            boolean ran;</span><br><span class="line">            try &#123;</span><br><span class="line">            	//执行主要方法</span><br><span class="line">                result = c.call();</span><br><span class="line">                ran = true;</span><br><span class="line">            &#125; catch (Throwable ex) &#123;</span><br><span class="line">            	//异常处理</span><br><span class="line">                result = null;</span><br><span class="line">                ran = false;</span><br><span class="line">                setException(ex);</span><br><span class="line">            &#125;</span><br><span class="line">            //如果执行成功，则设置结果和状态</span><br><span class="line">            if (ran)</span><br><span class="line">                set(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        // 将执行任务的执行线程置空</span><br><span class="line">        runner = null;</span><br><span class="line">        // state must be re-read after nulling runner to prevent</span><br><span class="line">        // leaked interrupts</span><br><span class="line">        int s = state;</span><br><span class="line">        //中断处理</span><br><span class="line">        if (s &gt;= INTERRUPTING)</span><br><span class="line">            handlePossibleCancellationInterrupt(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="set"><a href="#set" class="headerlink" title="set()"></a>set()</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* 执行结果的赋值操作, 子类可重写</span><br><span class="line">**/</span><br><span class="line">protected void set(V v) &#123;</span><br><span class="line">	//为state赋值COMPLETING</span><br><span class="line">    if (U.compareAndSwapInt(this, STATE, NEW, COMPLETING)) &#123;</span><br><span class="line">        outcome = v;</span><br><span class="line">        //赋值完成后，为state赋值NORMAL</span><br><span class="line">        U.putOrderedInt(this, STATE, NORMAL);</span><br><span class="line">        //完成处理</span><br><span class="line">        finishCompletion();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="finishCompletion"><a href="#finishCompletion" class="headerlink" title="finishCompletion()"></a>finishCompletion()</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* 在任务执行完成(包括取消、正常结束、发生异常), 将等待线程列表唤醒</span><br><span class="line">* 同时让任务执行体置空</span><br><span class="line">**/</span><br><span class="line">private void finishCompletion() &#123;</span><br><span class="line">    // assert state &gt; COMPLETING;</span><br><span class="line">    for (WaitNode q; (q = waiters) != null;) &#123;</span><br><span class="line">        if (U.compareAndSwapObject(this, WAITERS, q, null)) &#123;</span><br><span class="line">            for (;;) &#123;</span><br><span class="line">                Thread t = q.thread;</span><br><span class="line">                if (t != null) &#123;</span><br><span class="line">                    q.thread = null;</span><br><span class="line">                    //释放许可</span><br><span class="line">                    LockSupport.unpark(t);</span><br><span class="line">                &#125;</span><br><span class="line">                WaitNode next = q.next;</span><br><span class="line">                if (next == null)</span><br><span class="line">                    break;</span><br><span class="line">                q.next = null; // unlink to help gc</span><br><span class="line">                q = next;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	//完成之后需要执行的方法，该方法可重写</span><br><span class="line">    done();</span><br><span class="line"></span><br><span class="line">    callable = null;        // to reduce footprint</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="cancel-boolean-mayInterruptIfRunning"><a href="#cancel-boolean-mayInterruptIfRunning" class="headerlink" title="cancel(boolean mayInterruptIfRunning)"></a>cancel(boolean mayInterruptIfRunning)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public boolean cancel(boolean mayInterruptIfRunning) &#123;</span><br><span class="line">	//如果任务状态不是初始化状态,则取消任务</span><br><span class="line">    if (!(state == NEW &amp;&amp;</span><br><span class="line">          U.compareAndSwapInt(this, STATE, NEW,</span><br><span class="line">              mayInterruptIfRunning ? INTERRUPTING : CANCELLED)))</span><br><span class="line">        return false;</span><br><span class="line">    try &#123;    // in case call to interrupt throws exception</span><br><span class="line">        if (mayInterruptIfRunning) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">            	//则让执行线程中断(在这个过程中执行线程可能会改变任务的状态)</span><br><span class="line">                Thread t = runner;</span><br><span class="line">                if (t != null)</span><br><span class="line">                    t.interrupt();</span><br><span class="line">            &#125; finally &#123; // final state</span><br><span class="line">            	//改变任务状态为INTERRUPTED</span><br><span class="line">                U.putOrderedInt(this, STATE, INTERRUPTED);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">    	//处理任务完成的结果</span><br><span class="line">        finishCompletion();</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="get"><a href="#get" class="headerlink" title="get()"></a>get()</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public V get() throws InterruptedException, ExecutionException &#123;</span><br><span class="line">    int s = state;</span><br><span class="line">    if (s &lt;= COMPLETING)</span><br><span class="line">        s = awaitDone(false, 0L);</span><br><span class="line">    //返回结果值</span><br><span class="line">    return report(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="awaitDone-boolean-timed-long-nanos"><a href="#awaitDone-boolean-timed-long-nanos" class="headerlink" title="awaitDone(boolean timed, long nanos)"></a>awaitDone(boolean timed, long nanos)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* 等待任务的执行结果</span><br><span class="line">* timed: 是否有时间限制  nanos: 限制的时间</span><br><span class="line">**/ </span><br><span class="line">private int awaitDone(boolean timed, long nanos)</span><br><span class="line">    throws InterruptedException &#123;</span><br><span class="line">    long startTime = 0L;    // Special value 0L means not yet parked</span><br><span class="line">    WaitNode q = null;</span><br><span class="line">    boolean queued = false;</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        int s = state;</span><br><span class="line">        /**</span><br><span class="line">        * 1. 首先判断任务状态是否是完成状态, 是就直接返回结果</span><br><span class="line">        * 2. 如果1为false,并且任务的状态是COMPLETING, 也就是在set()任务结果时被阻塞了,则让出当前线程cpu资源</span><br><span class="line">        * 3. 如果前两步false,并且q==null,则初始化一个当前线程的等待节点</span><br><span class="line">        * 4. 下一次循环体, 如果前3步依然是false,并且当前节点没有加入到等待列表,</span><br><span class="line">        *     则将当前线程节点放在等待列表的第一个位置</span><br><span class="line">        * 5. 在下一次循环, 如果前4步为false, 如果是时间范围内等待的,则判断当前时间是否过期,</span><br><span class="line">        *    过期则将线程节点移出等待队列并返回任务状态结果, 如果没过期,则让当前线程阻塞一定时间</span><br><span class="line">        * 6. 如果不是时间范围内等待, 并且前5步均为false,则让线程阻塞,直到被唤醒</span><br><span class="line">        **/</span><br><span class="line">        if (s &gt; COMPLETING) &#123;</span><br><span class="line">            if (q != null)</span><br><span class="line">                q.thread = null;</span><br><span class="line">            return s;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (s == COMPLETING)</span><br><span class="line">            Thread.yield();</span><br><span class="line">        else if (Thread.interrupted()) &#123;</span><br><span class="line">            removeWaiter(q);</span><br><span class="line">            throw new InterruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">        else if (q == null) &#123;</span><br><span class="line">            if (timed &amp;&amp; nanos &lt;= 0L)</span><br><span class="line">                return s;</span><br><span class="line">            q = new WaitNode();</span><br><span class="line">        &#125;</span><br><span class="line">        else if (!queued)</span><br><span class="line">            queued = U.compareAndSwapObject(this, WAITERS,</span><br><span class="line">                                            q.next = waiters, q);</span><br><span class="line">        else if (timed) &#123;</span><br><span class="line">            final long parkNanos;</span><br><span class="line">            if (startTime == 0L) &#123; // first time</span><br><span class="line">                startTime = System.nanoTime();</span><br><span class="line">                if (startTime == 0L)</span><br><span class="line">                    startTime = 1L;</span><br><span class="line">                parkNanos = nanos;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                long elapsed = System.nanoTime() - startTime;</span><br><span class="line">                if (elapsed &gt;= nanos) &#123;</span><br><span class="line">                    removeWaiter(q);</span><br><span class="line">                    return state;</span><br><span class="line">                &#125;</span><br><span class="line">                parkNanos = nanos - elapsed;</span><br><span class="line">            &#125;</span><br><span class="line">            // nanoTime may be slow; recheck before parking</span><br><span class="line">            if (state &lt; COMPLETING)</span><br><span class="line">                LockSupport.parkNanos(this, parkNanos);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">            LockSupport.park(this);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注：如果你在源码中看到sun.misc.Unsafe，这个类是Java中直接操作内存的，可以理解为C语言中的指针，由于安全原因，Java并不向外部透露此类，使用时可以通过反射的方法。如果想要了解具体使用方法，请自行百度～  </p>
<h2 id="用法示例"><a href="#用法示例" class="headerlink" title="用法示例"></a>用法示例</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService executor = new ScheduledThreadPoolExecutor(2);</span><br><span class="line">FutureTask&lt;String&gt; future = new FutureTask&lt;&gt;(() -&gt; &#123;</span><br><span class="line">    System.out.println(&quot;FutureTask sleep..., Time is &quot; + System.currentTimeMillis());</span><br><span class="line">    Thread.sleep(5000);</span><br><span class="line">    return &quot;OK&quot;;</span><br><span class="line">&#125;);</span><br><span class="line">executor.execute(future);</span><br><span class="line">System.out.println(&quot;MainThread sleep..., Time is &quot; + System.currentTimeMillis());</span><br><span class="line">try &#123;</span><br><span class="line">    Thread.sleep(4000);</span><br><span class="line">&#125; catch (InterruptedException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">String result = &quot;&quot;;</span><br><span class="line">try &#123;</span><br><span class="line">    result = future.get();</span><br><span class="line">&#125; catch (InterruptedException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; catch (ExecutionException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(&quot;result is &quot; + result + &quot;, Time is &quot; + System.currentTimeMillis());</span><br></pre></td></tr></table></figure>
<p>执行结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MainThread sleep..., Time is 1491225495421</span><br><span class="line">FutureTask sleep..., Time is 1491225495421</span><br><span class="line">result is OK, Time is 1491225500426</span><br></pre></td></tr></table></figure></p>
<p> <img alt="关注我们" style="width: 66%" src="https://img.hchstudio.cn/dmxbl.jpg"></p><p style="margin-top: 40px; margin-bottom: 40px;"><span style="color: red;">作 者：</span><span class="author">ChanghuiN</span><br><span style="color: red;">原文链接：</span><a href="https://www.hchstudio.cn/article/2017/2b8f/">https://www.hchstudio.cn/article/2017/2b8f/</a><br><span style="color: red;">版权声明：非特殊声明均为本站原创作品，转载时请注明作者和原文链接。</span></p></div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://www.hchstudio.cn/article/2017/2b8f/" data-id="ckrdhqc91001fl4pv48689g47" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACMklEQVR42u3awa7DIAxE0f7/T/O2lSKsmXHzJMxlVaVJyGFh2YbPRx7razyvP+95Xq+fqmf52YABA8axjFUOhbF7qv7o3ZvrpdlSYcCAcQFjF8Gy6esQrM+lfBsMGDBg6AmcHhyzxBEGDBgwOgFXD6n1XEoQhwEDxs0MpYjVQ6Rbmupv+0EtDgMGjAMZetf9/3+/sr8BAwaMoxjLHEpY7HzWigYMGDBmM/RpOlub7qEK93tgwIBxGyMLndnRLndR7OwVBgwYIxhuM8stL7MFcht2MGDAmM3oT+AGR2X7IWy9wYABYyjDfZ3bknOTReUpaQ8WBgwYQxk6Ty9B3eWoD3NsFwIGDBijGf2ULksNlSVzy2AYMGDcwHADrtvo14N4zTBCMAwYMIYy+gWnUsoqs7RKYhgwYIxjKE03/WCEfkQj2wpt9Q5hwIBxLENPvPptsix9NFJDGDBgjGPoByyyEw5ZOqgHaBgwYNzAyFK3TlMsuyIlnTBgwBjNyDYX3fIya+TZm5cwYMAYyugHO7181TcJ9CIZBgwYtzHcZlmGdJNOY/cVBgwYoxl66paljGHG2j9sAQMGjMMZyxxKgNY/K9ty2CaFMGDAGMrIGl7Zq/vLYRwOgwEDxjhGFmTr9pn7VJZ6woAB4zaGm+rpR776Ra90JwwYMGDIv/tbm+6dMGDAgOEWqO8dC3slNYQBA8ZRDKWIVa4r/7pvkApgGDBgjGZ0SkflEGq2MeAmpjBgwBjK+AP9eSy6RU1ZvgAAAABJRU5ErkJggg==">分享</a><div class="tags"><a href="/tags/Java/" target="_blank">Java</a><a href="/tags/源码解析/" target="_blank">源码解析</a></div><div class="post-nav"><a class="pre" href="/article/2017/d3b2/">南锣鼓巷一游</a><a class="next" href="/article/2017/56cd/">Mysql 的七种 join</a></div><div id="gitalk-container"></div><link rel="stylesheet" type="text/css" href="/css/gitalk.css"><script type="text/javascript" src="/js/gitalk.min.js"></script><script>var gitalk = new Gitalk({
  clientID: '66106b18af72ad1fe98a',
  clientSecret: '5602bdf32cf5f90c31001be000afd88a48d6f563',
  repo: 'ChanghuiN.github.io',
  owner: 'ChanghuiN',
  admin: ['ChanghuiN'],
  id: location.pathname.split('/').slice(-2,-1)[0],
  distractionFreeMode: false
})
gitalk.render('gitalk-container')
</script><script>var cpro_id = "u3438285";</script><script src="https://cpro.baidustatic.com/cpro/ui/cm.js"></script></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget" style="margin-bottom: 20px"><img style="width: 100%" src="https://img.hchstudio.cn/qrcode_for_gh_e1d420c73d96_430.jpg"><sapn style="display: block; text-align: center">微信关注我们</sapn></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">59</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kafka-Java/">Kafka,Java</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kotlin/">Kotlin</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MapReduce/">MapReduce</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Raft/">Raft</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ThreadPoolExecutor/">ThreadPoolExecutor</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/go/">go</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/总结/">总结</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/旅游日记/">旅游日记</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/ChanghuiN/" style="font-size: 15px;">ChanghuiN</a> <a href="/tags/haifeiWu/" style="font-size: 15px;">haifeiWu</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/译文/" style="font-size: 15px;">译文</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Spring-Boot/" style="font-size: 15px;">Spring Boot</a> <a href="/tags/源码解析/" style="font-size: 15px;">源码解析</a> <a href="/tags/Kotlin/" style="font-size: 15px;">Kotlin</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/golang/" style="font-size: 15px;">golang</a> <a href="/tags/总结/" style="font-size: 15px;">总结</a> <a href="/tags/Kafka/" style="font-size: 15px;">Kafka</a> <a href="/tags/配置中心/" style="font-size: 15px;">配置中心</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/性能优化/" style="font-size: 15px;">性能优化</a> <a href="/tags/旅游日记/" style="font-size: 15px;">旅游日记</a> <a href="/tags/Shell/" style="font-size: 15px;">Shell</a> <a href="/tags/Go/" style="font-size: 15px;">Go</a> <a href="/tags/问题排查/" style="font-size: 15px;">问题排查</a> <a href="/tags/工具/" style="font-size: 15px;">工具</a> <a href="/tags/学习笔记/" style="font-size: 15px;">学习笔记</a> <a href="/tags/WebFlux/" style="font-size: 15px;">WebFlux</a> <a href="/tags/性能测试/" style="font-size: 15px;">性能测试</a> <a href="/tags/go/" style="font-size: 15px;">go</a> <a href="/tags/散列表/" style="font-size: 15px;">散列表</a> <a href="/tags/源码/" style="font-size: 15px;">源码</a> <a href="/tags/netty/" style="font-size: 15px;">netty</a> <a href="/tags/Raft/" style="font-size: 15px;">Raft</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/article/2021/7cba/">Kafka的日志复制机制</a></li><li class="post-list-item"><a class="post-list-link" href="/article/2021/8e2f/">从20到21</a></li><li class="post-list-item"><a class="post-list-link" href="/article/2020/e8fc/">go 并发编程</a></li><li class="post-list-item"><a class="post-list-link" href="/article/2020/ce5a/">【译】了解Linux CPU负载-您何时应该担心？</a></li><li class="post-list-item"><a class="post-list-link" href="/article/2020/4d59/">Zookeeper 与分布式锁</a></li><li class="post-list-item"><a class="post-list-link" href="/article/2020/7bc5/">基于Redis的分布式锁到底安全吗？</a></li><li class="post-list-item"><a class="post-list-link" href="/article/2020/62e/">【译】Raft 学生指南</a></li><li class="post-list-item"><a class="post-list-link" href="/article/2020/c5a/">ThreadPoolExecutor 的简单梳理</a></li><li class="post-list-item"><a class="post-list-link" href="/article/2020/1ed5/">MapReduce 的简单实现</a></li><li class="post-list-item"><a class="post-list-link" href="/article/2020/4a72/">使用 Map 实现策略模式</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 福利专区</i></div><ul></ul><a href="https://cloud.tencent.com/redirect.php?redirect=1009&amp;cps_key=c809e5f9177c6354f546e3e79ffba96f&amp;from=console" title="免费SSL证书" target="_blank">免费SSL证书</a><ul></ul><a href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=mqspr2q3" title="阿里云红包" target="_blank">阿里云红包</a><ul></ul><a href="https://cloud.tencent.com/redirect.php?redirect=1025&amp;cps_key=c809e5f9177c6354f546e3e79ffba96f&amp;from=console" title="腾讯云专属福利" target="_blank">腾讯云专属福利</a></div><div class="widget"><div class="widget-title"><script>var cpro_id = "u3438277";</script><script src="//cpro.baidustatic.com/cpro/ui/c.js"></script><script>var cpro_id = "u3438277";</script><script src="//cpro.baidustatic.com/cpro/ui/c.js"></script><script>var cpro_id = "u3438277";</script><script src="//cpro.baidustatic.com/cpro/ui/c.js"></script></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">代码星冰乐.</a> Powered by<a rel="nofollow" target="_blank" style="font-weight: bold" href="https://www.hchstudio.cn"> ChanghuiN.</a> 版权所有 晋ICP备15001365号<br><span>特别感谢：</span><a rel="nofollow" target="_blank" style="font-weight: bold" href="https://cloud.tencent.com/redirect.php?redirect=1005&amp;cps_key=c809e5f9177c6354f546e3e79ffba96f&amp;from=console."> 云服务器服务商</a> 、<a rel="nofollow" target="_blank" style="font-weight: bold" href="https://portal.qiniu.com/signup?code=3lor2p0wm2frm."> CDN 服务商</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.css"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?57858db5693024385f944247dd150c32";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https'){
  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
} else{
  bp.src = 'https://push.zhanzhang.baidu.com/push.js';
}
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script></div></body></html>